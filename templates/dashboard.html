<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій Кабінет - Kvit.ok</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body>

    <header class="glass-effect">
        <a href="{{ url_for('index') }}" class="logo-placeholder">[ Kvit.ok ]</a>

        <div class="auth-buttons">
            <a href="{{ url_for('dashboard_page') }}" class="account-icon" aria-label="Мій акаунт">
                <i class="fas fa-user-circle"></i>
            </a>
        </div>
    </header>

    <div class="hybrid-wrapper">

        <aside class="filter-sidebar glass-effect">
            <h3>Привіт, {{ current_user.name }}!</h3>
            <p style="font-size: 0.9em; color: gray;">Ваш статус:
                {% if current_user.role == 'organizer' %}Організатор
                {% elif current_user.role == 'admin' %}Адміністратор
                {% else %}Клієнт
                {% endif %}
            </p>

            <nav class="dashboard-nav">
                <a href="#" class="nav-item active">
                    <i class="fas fa-calendar-check"></i> Мій Розклад
                </a>

                {% if current_user.role == 'organizer' or current_user.role == 'admin' %}
                <a href="#" class="nav-item" onclick="openCreateModal()">
                    <i class="fas fa-plus-circle"></i> Створити Подію
                </a>
                {% endif %}

                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('admin_panel') }}" class="nav-item"
                    style="color: #e67e22; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px; margin-top: 10px;">
                    <i class="fas fa-tools"></i> Панель Адміна
                </a>
                {% endif %}

                <a href="{{ url_for('logout') }}" class="nav-item logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Вийти
                </a>
            </nav>
        </aside>


        <main class="event-list">
            <h2 class="section-title">Мій Розклад</h2>
            <p class="subtitle">Події, на які ви зареєстровані.</p>

            <div id="my-tickets-container">
                <div class="schedule-item glass-effect" style="padding: 20px; text-align:center">
                    <p>Завантаження квитків...</p>
                </div>
            </div>

            <div id="createEventModal" class="modal-overlay">
                <div class="modal-window glass-effect">
                    <div class="modal-header">
                        <h2>Створити нову подію</h2>
                        <span class="close-modal" onclick="closeCreateModal()">&times;</span>
                    </div>

                    <form id="create-event-form" enctype="multipart/form-data">
                        <div class="form-grid">
                            <div class="form-column">
                                <label>Назва події:</label>
                                <input type="text" name="title" placeholder="Концерт гурту..." required>

                                <label>Дата:</label>
                                <input type="date" name="date" required>

                                <label>Час:</label>
                                <input type="time" name="time" required>

                                <label>Локація:</label>
                                <select name="location">
                                    <option value="Головна Сцена">Головна Сцена</option>
                                    <option value="Atlas">Atlas</option>
                                    <option value="Malevich">Malevich</option>
                                    <option value="Лофт">Лофт</option>
                                    <option value="Оперний театр">Оперний театр</option>
                                </select>
                            </div>
                            <div class="form-column">
                                <label>Тип:</label>
                                <select name="type">
                                    <option value="Концерт">Концерт</option>
                                    <option value="Театр">Театр</option>
                                    <option value="Освіта">Освіта</option>
                                    <option value="Спорт">Спорт</option>
                                    <option value="Виставка">Виставка</option>
                                    <option value="Кіно">Кіно</option>
                                </select>

                                <label>Вартість (грн):</label>
                                <input type="number" name="price" placeholder="0" required>

                                <label>Фотографії події:</label>
                                <input type="file" id="event-images" name="images" accept="image/png, image/jpeg, image/jpg, image/webp" multiple
                                    style="padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 100%;">
                                <p style="font-size: 0.8em; color: gray; margin-top: 5px;">
                                    <i class="fas fa-info-circle"></i> Вимоги: до 5 фото, макс. 5 MB кожне. Формати: JPG, PNG, WEBP.
                                </p>
                                <div class="row-inputs">
                                    <div><label>Всього:</label><input type="number" name="total_seats" id="total_seats"
                                            value="100"></div>
                                    <div><label>Залишилось:</label><input type="number" name="remaining_seats"
                                            id="remaining_seats" value="100"></div>
                                </div>
                            </div>
                        </div>
                        <label>Опис події:</label>
                        <textarea name="description" rows="3" placeholder="Деталі події..."></textarea>

                        <button type="submit" class="main-cta-button"
                            style="width: 100%; margin-top: 20px;">Створити</button>
                    </form>
                </div>
            </div>

            <div id="dashboardDetailsModal" class="modal-overlay">
                <div class="modal-window glass-effect" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 id="dash-details-title">...</h2>
                        <span class="close-modal" onclick="closeDashDetails()">&times;</span>
                    </div>
                    <div class="modal-body" style="text-align: left;">

                        <div id="dash-gallery-container"></div>

                        <p style="font-size: 0.9em; color: gray; margin-bottom: 10px;">
                            <i class="fas fa-clock"></i> <span id="dash-details-time"></span> |
                            <i class="fas fa-map-marker-alt"></i> <span id="dash-details-location"></span>
                        </p>

                        <div id="dash-details-description"
                            style="line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-window glass-effect success-modal-content" style="max-width: 400px;">
            <div class="success-icon-box">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="success-title" id="success-modal-title">Чудово!</h2>
            <p class="success-message" id="success-modal-msg">Операція пройшла успішно.</p>
            <button class="main-cta-button" onclick="closeSuccessModal()" style="width: 100%;">Зрозуміло</button>
        </div>
    </div>

    <div id="cancelModal" class="modal-overlay">
        <div class="modal-window glass-effect" style="max-width: 400px; text-align: center; padding: 40px;">
    
            <div style="margin-bottom: 20px; animation: popIn 0.5s;">
                <i class="fas fa-exclamation-triangle" style="font-size: 4em; color: #e74c3c;"></i>
            </div>
    
            <h2 style="margin-bottom: 10px; color: var(--text-dark);">Скасування квитка</h2>
    
            <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1em;">
                Ви впевнені, що хочете повернути цей квиток? <br>
                <span style="font-size: 0.9em; color: #e74c3c;">Це звільнить місце для інших відвідувачів.</span>
            </p>
    
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="main-cta-button" onclick="closeCancelModal()" style="background-color: #95a5a6; flex: 1;">
                    Ні, залишити
                </button>
                <button class="main-cta-button" onclick="processCancellation()"
                    style="background-color: #e74c3c; flex: 1; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);">
                    Так, скасувати
                </button>
            </div>
        </div>
    </div>

    <script>
        let onModalCloseCallback = null;
        function showSuccessModal(title, message, callback) {
            document.getElementById('success-modal-title').innerText = title;
            document.getElementById('success-modal-msg').innerText = message;
            document.getElementById('successModal').style.display = 'flex';
            onModalCloseCallback = callback;
        }
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            if (onModalCloseCallback) {
                onModalCloseCallback();
                onModalCloseCallback = null;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('my-tickets-container');

            try {
                const response = await fetch('/api/my_events');
                const events = await response.json();

                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="schedule-item glass-effect" style="padding: 20px; margin-bottom: 20px;">
                            <p>У вас поки немає активних квитків.</p>
                            <a href="{{ url_for('index') }}" class="main-cta-button">Знайти подію</a>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    events.forEach(ev => {
                        const safeDesc = (ev.description || "").replace(/"/g, '&quot;');
                        const safeImg = ev.image_url || "";

                        // ... всередині events.forEach
                        container.innerHTML += `
    <div class="event-list-card glass-effect" style="opacity: 1; transform: none; border-left: 5px solid var(--mint-primary);">
        <div class="event-time" style="font-size: 1.4em;">
            ${ev.time}<br>
            <span style="font-size: 0.5em; color: gray;">${ev.date}</span>
        </div>
        <div class="event-info">
            <h4 class="event-title">${ev.title}</h4>
            <p class="event-meta">
                <i class="fas fa-map-marker-alt"></i> ${ev.location}
            </p>
        </div>
        <div class="event-action" style="display: flex; flex-direction: column; gap: 5px;">
            <button class="main-cta-button" style="background-color: #555; cursor: default;">
                <i class="fas fa-check"></i> Куплено
            </button>
            
            <button class="main-cta-button" style="background-color: #95a5a6; font-size: 0.8em;"
                onclick="openDashDetails('${ev.title}', '${ev.time}', '${ev.location}', '${safeDesc}', '${safeImg}')">
                <i class="fas fa-info-circle"></i> Інфо
            </button>

            <button class="main-cta-button" style="background-color: #e74c3c; font-size: 0.8em;"
                onclick="cancelTicket(${ev.id})">
                <i class="fas fa-times-circle"></i> Скасувати
            </button>
        </div>
    </div>
`;
                    });
                }
            } catch (error) {
                console.error('Помилка:', error);
                container.innerHTML = '<p style="color:red">Помилка завантаження даних.</p>';
            }
        });

        const detailsModal = document.getElementById('dashboardDetailsModal');

        function openDashDetails(title, time, location, description, imageUrl) {
            document.getElementById('dash-details-title').innerText = title;
            document.getElementById('dash-details-time').innerText = time;
            document.getElementById('dash-details-location').innerText = location;
            document.getElementById('dash-details-description').innerText = description || "Опис відсутній.";

            const galleryContainer = document.getElementById('dash-gallery-container');
            galleryContainer.innerHTML = ''; 
            galleryContainer.className = 'gallery-scroll'; 

            if (imageUrl && imageUrl !== 'null') {
                let images = [];
                if (imageUrl.includes('http')) {
                    images.push(imageUrl);
                } else {
                    images = imageUrl.split(',').map(f => `/static/uploads/${f}`);
                }

                images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = 'gallery-item';
                    galleryContainer.appendChild(img);
                });
                galleryContainer.style.display = 'flex';
            } else {
                galleryContainer.style.display = 'none';
            }

            detailsModal.style.display = 'flex';
        }

        function closeDashDetails() {
            detailsModal.style.display = 'none';
        }

        const createModal = document.getElementById('createEventModal');

        function openCreateModal() { createModal.style.display = 'flex'; }
        function closeCreateModal() { createModal.style.display = 'none'; }

        window.onclick = function (event) {
            if (event.target == createModal) closeCreateModal();
            if (event.target == detailsModal) closeDashDetails();
            if (event.target == document.getElementById('successModal')) closeSuccessModal();
        }

        document.getElementById('total_seats')?.addEventListener('input', function () {
            document.getElementById('remaining_seats').value = this.value;
        });

        document.getElementById('create-event-form')?.addEventListener('submit', async function (e) {
                e.preventDefault();

                const fileInput = document.getElementById('event-images');
                const files = fileInput.files;
                const maxFiles = 5;
                const maxSize = 5 * 1024 * 1024; 

                if (files.length > maxFiles) {
                    alert(`Забагато фото! Максимум дозволено: ${maxFiles}. Ви обрали: ${files.length}.`);
                    return; 
                }

                for (let i = 0; i < files.length; i++) {
                    if (files[i].size > maxSize) {
                        alert(`Файл "${files[i].name}" занадто великий! Максимум 5 MB.`);
                        return; 
                    }
                }
            

                const formData = new FormData(e.target);
           

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "Завантаження...";

            try {
                const response = await fetch('/api/create_event', {
                    method: 'POST',
                    
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    closeCreateModal();
                    showSuccessModal(
                        "Успіх!",
                        "Подію та фото завантажено.",
                        () => location.reload()
                    );
                } else {
                    alert('Помилка: ' + result.message);
                    btn.disabled = false;
                    btn.innerText = "Створити";
                }
            } catch (error) {
                console.error(error);
                alert('Помилка з\'єднання');
                btn.disabled = false;
                btn.innerText = "Створити";
            }
        });
        
        window.cancelTicket = async function (eventId) {
                if (!confirm('Ви впевнені, що хочете скасувати цей квиток? Це звільнить місце для інших.')) {
                    return;
                }

                try {
                    const response = await fetch('/api/cancel_ticket', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event_id: eventId })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessModal(
                            "Скасовано",
                            "Ваш квиток успішно анульовано.",
                            () => location.reload()
                        );
                    } else {
                        alert('Помилка: ' + result.message);
                    }
                } catch (error) {
                    console.error('Помилка:', error);
                    alert('Помилка з\'єднання із сервером');
                }
            }
        

            let ticketIdToCancel = null; // Змінна для збереження ID події
                const cancelModal = document.getElementById('cancelModal');

                // 1. Ця функція викликається при натисканні кнопки на картці
                window.cancelTicket = function (eventId) {
                    ticketIdToCancel = eventId; // Запам'ятовуємо ID
                    cancelModal.style.display = 'flex'; // Відкриваємо красиве вікно
                }

                // 2. Функція закриття вікна
                window.closeCancelModal = function () {
                    cancelModal.style.display = 'none';
                    ticketIdToCancel = null;
                }

                // 3. Закриття при кліку поза вікном
                window.onclick = function (event) {
                    if (event.target == cancelModal) closeCancelModal();
                    // ... ваш існуючий код для інших вікон ...
                    if (event.target == document.getElementById('createEventModal')) closeCreateModal();
                    if (event.target == document.getElementById('dashboardDetailsModal')) closeDashDetails();
                    if (event.target == document.getElementById('successModal')) closeSuccessModal();
                }

                // 4. Основна логіка скасування (виконується, коли натиснули "Так, скасувати")
                window.processCancellation = async function () {
                    if (!ticketIdToCancel) return;

                    // Змінюємо текст кнопки, щоб показати процес
                    const confirmBtn = document.querySelector('#cancelModal button[onclick="processCancellation()"]');
                    const originalText = confirmBtn.innerText;
                    confirmBtn.innerText = "Обробка...";
                    confirmBtn.disabled = true;

                    try {
                        const response = await fetch('/api/cancel_ticket', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event_id: ticketIdToCancel })
                        });

                        const result = await response.json();

                        closeCancelModal(); // Закриваємо вікно питання

                        if (result.success) {
                            // Показуємо вікно успіху
                            showSuccessModal(
                                "Повернення оформлено",
                                "Ваш квиток успішно анульовано. Дякуємо, що попередили.",
                                () => location.reload()
                            );
                        } else {
                            alert('Помилка: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Помилка:', error);
                        alert('Помилка з\'єднання із сервером');
                    } finally {
                        // Повертаємо кнопку до початкового стану
                        confirmBtn.innerText = originalText;
                        confirmBtn.disabled = false;
                    }
                }
    </script>
</body>

</html>